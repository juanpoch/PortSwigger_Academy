# Lab: Modifying serialized objects

This lab uses a serialization-based session mechanism and is vulnerable to privilege escalation as a result. To solve the lab, edit the serialized object in the session cookie to exploit this vulnerability and gain administrative privileges. Then, delete the user `carlos`.

You can log in to your own account using the following credentials: `wiener:peter`

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de compras online:
![image](https://github.com/user-attachments/assets/0e746c46-a1ce-4bc2-8df7-59c5ad260458)

Nosotros sabemos que este laboratorio tiene un mecanismo de serializaci√≥n vulnerable en el manejo de sesiones que permite una escalada de privilegios. Tenemos que editar el objeto serializado en la cookie de sesi√≥n para explotar la vulnerabilidad y eliminar el usuario `carlos`.

Nos autenticamos con nuestras credenciales `wiener:peter`:
![image](https://github.com/user-attachments/assets/81291614-90a4-4389-bc02-0570337de188)

El servidor nos devuelve una cookie llamada session que contiene un objeto PHP serializado, codificado en Base64. Este objeto representa el estado del usuario autenticado.
![image](https://github.com/user-attachments/assets/ddd86c00-ba41-45e2-980a-159b64df4f7e)

Concretamente nos devuelve:
```php
O:4:"User":2:{s:8:"username";s:6:"wiener";s:5:"admin";b:0;}
```
Este es un objeto **PHP serializado** de la clase `User`, con dos atributos:

- `username` ‚Üí `"wiener"`
- `admin` ‚Üí `b:0` (booleano con valor `false`)

Al cambiar `b:0` por `b:1`, estamos modificando el **estado interno del objeto** y otorg√°ndonos privilegios de administrador.

Esto evidencia que el servidor **conf√≠a ciegamente en los datos serializados enviados por el cliente**, sin aplicar ning√∫n tipo de validaci√≥n, firma o control de integridad.

Si observamos el endpoint `/my-account?id=wiener` vemos que estamos utilizando esta cookie que nos configur√≥ el servidor, notamos que no tenemos acceso al panel administrativo porque el booleano tiene el valor de 0:
![image](https://github.com/user-attachments/assets/437cb6fd-1b1e-404e-8040-7f8e80a1a833)

Enviamos la petici√≥n al Repeater y cambiamos el booleano a 1:
![image](https://github.com/user-attachments/assets/8ed74694-cce1-48fb-af9a-48409a029e63)

Si enviamos la petici√≥n, vemos que ahora s√≠ tenemos acceso al panel administrativo:
![image](https://github.com/user-attachments/assets/ddb873e7-5d1f-4518-b215-5f721173b777)

En este punto confirmamos que obtuvimos escalada de privilegios gracias a una vulnerabilidad de `Insecure deserialization`:
![image](https://github.com/user-attachments/assets/02928fdb-8099-473d-aaa0-b04943af315b)


Procedemos a eliminar el usuario `carlos` para resolver el laboratorio:
![image](https://github.com/user-attachments/assets/dc70f8e1-3cdc-4465-a9fa-632879e4caf9)

![image](https://github.com/user-attachments/assets/3b0a4601-3f35-4846-8a4a-3699c253e4d0)

---

---

## ‚úÖ Conclusiones

Este laboratorio demostr√≥ c√≥mo una aplicaci√≥n vulnerable a **Insecure Deserialization** puede ser explotada para realizar una **escalada de privilegios** modificando atributos dentro de un objeto serializado en una cookie.

La ausencia de validaci√≥n, firma o verificaci√≥n de integridad sobre el objeto permiti√≥ alterar el valor del atributo `admin` y obtener acceso al panel de administraci√≥n sin credenciales privilegiadas.

---

## üõ†Ô∏è Recomendaciones

- üîí **Nunca confiar en datos serializados del lado del cliente.**
- ‚úÖ Implementar **firmas digitales (HMAC)** sobre los datos serializados y verificar su integridad antes de deserializar.
- ‚ùå Evitar completamente la deserializaci√≥n de datos no confiables si no es absolutamente necesario.
- üß± Usar mecanismos de control de acceso del lado del servidor, independientemente del estado declarado por el cliente.
- üîç Revisar el uso de funciones como `unserialize()` en PHP y aplicar filtros o wrappers seguros.

---

## üìö Lecciones aprendidas

- La deserializaci√≥n insegura permite modificar atributos internos de objetos que el servidor espera como v√°lidos.
- PHP serializa objetos de forma textual, lo que facilita su an√°lisis y manipulaci√≥n si se codifican en Base64.
- La falta de verificaci√≥n de autenticidad en objetos serializados puede resultar en escaladas de privilegios y acceso no autorizado.
- Herramientas como **Burp Suite** permiten inspeccionar, decodificar y modificar cookies f√°cilmente para llevar a cabo estos ataques.




