# Lab: High-level logic vulnerability

This lab doesn't adequately validate user input. You can exploit a logic flaw in its purchasing workflow to buy items for an unintended price. To solve the lab, buy a "Lightweight l33t leather jacket".

You can log in to your own account using the following credentials: `wiener:peter`

![Practitioner](https://img.shields.io/badge/level-Apprentice-green)  

---

Este laboratorio simula una vulnerabilidad de l√≥gica de negocio donde la aplicaci√≥n no valida correctamente el flujo de compra. Esto permite manipular el carrito para obtener productos sin pagar su precio real.

Iniciamos el laboratorio y tenemos una aplicaci√≥n para hacer compras:
![image](https://github.com/user-attachments/assets/bd1c8c1c-44ea-497e-b431-feb5d61aaf68)

Accedemos al panel de login usando el bot√≥n `My account` e iniciamos sesi√≥n con nuestras credenciales:
![image](https://github.com/user-attachments/assets/84a9859b-2751-4922-aba7-beb0fe37b181)

En nuestro dashboard, vemos que tenemos disponibles $100 para hacer compras:
![image](https://github.com/user-attachments/assets/66342365-edac-4430-bcee-38bb4c9f8f82)

Hacemos click en `home` y vemos que la chaqueta tiene un precio m√°s elevado que nuestro presupuesto:
![image](https://github.com/user-attachments/assets/1f059599-44dd-4cfd-9b68-09d91d570e8a)


Interceptamos con `Burp Suite` para analizar el flujo, primero hacemos click en `View details`:
![image](https://github.com/user-attachments/assets/e8e1610c-ad0e-453e-a183-9eba049dd3c0)
![image](https://github.com/user-attachments/assets/12a54f4e-55ff-4d74-a1a4-8730d78f6b99)

Luego a√±adimos al carrito:
![image](https://github.com/user-attachments/assets/f9db3926-9cea-44de-900c-36eafa183791)

Esta es una petici√≥n `POST` que tramita los par√°metros `productId=1&redir=PRODUCT&quantity=1`, esto quiere decir que agregamos al carrito el `productId=1`, nos redirije a la p√°gina del producto (respuesta `302, Location: /product?productId=1`) y solicitamos la cantidad de 1 producto.

Luego hacemos click en el carrito para dirigirnos al dashboard `/cart`:
![image](https://github.com/user-attachments/assets/04b3d0cb-0815-4e2b-bd25-cf092abf3fc0)

Petici√≥n en `Burp Suite`:
![image](https://github.com/user-attachments/assets/572c1999-5b61-4013-bf34-82c6b8314f09)

Intentamos hacer la compra haciendo click en `Place order` y nos da el mensaje que no tenemos suficientes fondos:
![image](https://github.com/user-attachments/assets/657af2eb-d97f-498a-8297-a12a53edadf1)

![image](https://github.com/user-attachments/assets/0c380419-8bd9-47ee-9255-2091a64995b4)


Volvemos a nuestra solicitud `POST` que maneja par√°metros, vamos a intentar modificar los valores para analizar la l√≥gica.

Primero intentamos restar un producto al carrito:
![image](https://github.com/user-attachments/assets/d059c5fc-163e-47c4-8cf1-0848a4c3b81a)

Si accedemos al carrito, vemos que nos dice que est√° vac√≠o:
![image](https://github.com/user-attachments/assets/0b221cbc-99c9-47b7-8ff5-ae48e09a397e)

Ahora vemos qu√© pasa si intentamos restar otro producto:
![image](https://github.com/user-attachments/assets/b5111a36-38fb-4901-a95e-8587ca954ed4)

Vemos que nos resta el producto en el carrito, es decir que nos acredita su valor:
![image](https://github.com/user-attachments/assets/7b719c51-ddeb-4257-8122-fd77f01edd4b)

Vamos a agregar el producto que queremos comprar y restarnos un n√∫mero grande del producto 1 para acreditarnos el dinero suficiente:
![image](https://github.com/user-attachments/assets/d29bba11-6349-452a-ac93-91c1f05e5984)


![image](https://github.com/user-attachments/assets/144bea15-a960-4137-a95a-1e2fda2142de)

![image](https://github.com/user-attachments/assets/93e293dd-c179-4786-9b6f-9a77a063cbef)

Intentamos comprar el producto y nos dice que el valor total no puede ser inferior a 0:
![image](https://github.com/user-attachments/assets/842e84cd-f359-479d-8e6a-489e9f77162f)

Por lo que iremos a√±adiendo el producto 2 hasta que podamos comprarlo:
![image](https://github.com/user-attachments/assets/f7b2e624-2cca-4285-ac41-5c40fb95cc1a)

Compramos el producto y resolvemos el laboratorio:
![image](https://github.com/user-attachments/assets/d3994cad-b309-4297-a8ab-6ff6a7a06710)

---

## ‚úÖ Conclusiones

Este laboratorio demuestra c√≥mo una vulnerabilidad de l√≥gica de negocio permite evadir restricciones econ√≥micas manipulando el flujo de compras. El backend conf√≠a ciegamente en los datos enviados por el cliente, permitiendo que el atacante manipule su propio saldo de manera indebida.

---

## üõ°Ô∏è Recomendaciones

- Validar en el servidor que el monto total nunca sea negativo.
- Impedir que los usuarios restablezcan el estado del carrito mediante cantidades negativas.
- Agregar controles en el backend que aseguren que los precios y cantidades no sean manipulados.
- Implementar l√≥gica que calcule el total del carrito del lado del servidor, no del cliente.

---

## üìö Lecciones aprendidas

- Las validaciones cr√≠ticas nunca deben realizarse exclusivamente en el cliente.
- Las vulnerabilidades de l√≥gica pueden ser igual de peligrosas que las t√©cnicas.
- Un pentester debe pensar en t√©rminos de **abuso del flujo l√≥gico**, no solo en inyecciones o bugs t√©cnicos.
- Interceptar, modificar y reintentar solicitudes es clave para descubrir este tipo de fallos.


