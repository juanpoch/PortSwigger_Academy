# Lab: Exploiting XXE using external entities to retrieve files

This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.

To solve the lab, inject an XML external entity to retrieve the contents of the `/etc/passwd` file.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---


Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de shopping:
![image](https://github.com/user-attachments/assets/56a61334-623e-4cfa-bd40-0b25b4550af0)

Accedemos a la descripci√≥n de un producto haciendo click en `View details`:
![image](https://github.com/user-attachments/assets/f8eae5bf-e647-4f4c-aff7-fb6974f55fee)

Este laboratorio nos dice que tiene una vulnerabilidad en la funcionalidad `Check stock`:
![image](https://github.com/user-attachments/assets/efc2f1da-39d8-411d-bcaa-bd09db8aa096)

Por lo que procedemos a analizarla:
![image](https://github.com/user-attachments/assets/d64ce980-fa52-40b3-bc1a-60c088c72e60)


Esta captura muestra un escenario cl√°sico y perfectamente explotable de XXE.

Estamos enviando informaci√≥n v√≠a XML en la request:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```
El servidor responde con 759, lo que indica que interpreta y procesa correctamente el XML enviado.

Indicios:
- El servidor est√° procesando directamente el contenido XML que el cliente env√≠a, lo cual es el punto de partida para probar inyecciones de entidades externas.

- No hay evidencias de validaci√≥n ni sanitizaci√≥n del XML.

- Si el servidor usa un parser vulnerable que permite entidades externas, podr√≠amos intentar algo como:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ <!ENTITY test "test"> ]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

En este caso estamos definiendo un `DTD` que contiene una entidad interna `test` con el valor "test".
Aunque en este ejemplo **no estamos utilizando la entidad `&test;` dentro del XML**, esto **sirve como prueba inicial** para verificar si el servidor acepta la inclusi√≥n de un `DOCTYPE`. Esto puede revelar si:

- El parser XML est√° configurado para **procesar DTDs internos**.
- Existen **controles de seguridad que bloqueen la definici√≥n de entidades** (por ejemplo, filtros WAF).
- Se producen errores de parsing, lo cual podr√≠a indicar una **superficie vulnerable a ataques XXE**.

Analizamos la petici√≥n en Burp Suite:
![image](https://github.com/user-attachments/assets/7fc94c72-0b57-4523-b9d7-6c0dd8c46277)

El siguiente paso es confirmar si el servidor resuelve y expande entidades, por lo que referenciaremos la entidad:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ <!ENTITY test "XXE Working"> ]>
<stockCheck>
  <productId>&test;</productId>
  <storeId>1</storeId>
</stockCheck>
```

Analizamos el resultado de la petici√≥n:
![image](https://github.com/user-attachments/assets/c5251071-f42b-4d64-af51-4ffd3d1f77e5)

El servidor respondi√≥n `"Invalid product ID: XXE Working"`, esto prueba que:

- El parser XML acept√≥ tu definici√≥n <!ENTITY>.

- La entidad `&test;` fue resuelta correctamente.

- El contenido de la entidad fue inyectado din√°micamente en el valor del productId.

- El servidor reflej√≥ ese valor en la respuesta.

Este es un ejemplo de XXE cl√°sico tipo ‚Äúdata disclosure‚Äù, donde un atacante podr√≠a en lugar de "XXE Working" poner, por ejemplo:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

Analizamos la request en Burp Suite:
![image](https://github.com/user-attachments/assets/a430856a-57a7-487b-99e5-438e3fd6cc9f)

Esta captura confirma de forma indiscutible que se explot√≥ exitosamente una vulnerabilidad de tipo XML External Entity - File Disclosure.

Este comportamiento muestra:

- Que el parser XML est√° mal configurado (no tiene desactivado el procesamiento de entidades externas).

- Que no hay validaci√≥n ni filtrado del contenido XML por parte del backend.

- Que un atacante puede leer archivos arbitrarios del servidor (Local File Disclosure).

- Y potencialmente podr√≠a derivar en Remote Code Execution (en ciertos contextos, como Java + deserializaci√≥n).

### Explicaci√≥n del exploit

El servidor esperaba que el valor de `productId` fuera un n√∫mero v√°lido para verificar el stock. Sin embargo, en lugar de enviar un n√∫mero, inyectamos una **referencia a una entidad externa** definida en el encabezado del XML:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<stockCheck>
  <productId>&xxe;</productId>
  <storeId>1</storeId>
</stockCheck>
```

Este XML hace lo siguiente:

* Declara una entidad externa llamada `xxe` cuyo valor es el contenido del archivo `/etc/passwd`.
* Inserta `&xxe;` dentro del nodo `<productId>`, haciendo que el **parser XML** reemplace esa referencia por el contenido real del archivo.
* Como el servidor utiliza la entrada de `productId` y la refleja en su respuesta (en este caso, indicando que el ID es inv√°lido), el contenido de `/etc/passwd` queda expuesto dentro del mensaje de error.

Este comportamiento confirma que:

‚úÖ El servidor est√° procesando entidades externas (lo que no deber√≠a hacer por seguridad).
‚úÖ El contenido del archivo fue correctamente incluido en la respuesta, probando la vulnerabilidad XXE.


![image](https://github.com/user-attachments/assets/b4004786-829d-49cb-a26d-f78f7a49132c)



---

## üîπ Conclusiones

Este laboratorio demuestra c√≥mo una funcionalidad leg√≠tima que procesa datos en formato XML puede ser explotada para leer archivos internos del sistema mediante una vulnerabilidad **XXE (XML External Entity)**.

Pudimos comprobar que el servidor utiliza un parser XML que permite la definici√≥n y resoluci√≥n de entidades externas (`SYSTEM`). Al referenciar la entidad `&xxe;` en el campo `productId`, el servidor carg√≥ y reflej√≥ el contenido del archivo `/etc/passwd` en la respuesta.

Esto confirma:

* El parser no tiene deshabilitada la expansi√≥n de entidades externas.
* El servidor conf√≠a impl√≠citamente en el contenido procesado desde XML.
* El valor reflejado en la respuesta permite validar f√°cilmente el √©xito del ataque.

---

## üë§ Recomendaciones

Para prevenir este tipo de vulnerabilidades:

* ‚ùå **No permitir entidades externas (XXE)**: Deshabilitar DTDs y la expansi√≥n de entidades externas en el parser XML.
* ‚úÖ **Validar el contenido XML recibido**: Usar esquemas XML seguros (`XSD`) para validar los datos esperados.
* üîê **Aplicar el principio de privilegios m√≠nimos**: El proceso que parsea XML no debe tener permisos para acceder a archivos sensibles del sistema.
* üõ°Ô∏è **Analizar si realmente se necesita XML**: Si es posible, usar formatos m√°s seguros como JSON.

---

## üìÉ Lecciones aprendidas

* Las entidades externas pueden ser usadas como vectores de ataque para acceder a archivos internos.
* No es necesario que la aplicaci√≥n tenga una interfaz expl√≠cita para cargar archivos: basta con que procese XML sin protecci√≥n.
* Al recibir un error que refleje parte del contenido del archivo (`Invalid product ID: root:x:0:0:...`) tenemos una se√±al clara de √©xito.
* El conocimiento de DTDs, entidades y c√≥mo funciona un XML parser es clave para explotar (y prevenir) este tipo de fallas.
* Las vulnerabilidades XXE pueden ser la puerta de entrada a ataques m√°s graves como SSRF o RCE.



