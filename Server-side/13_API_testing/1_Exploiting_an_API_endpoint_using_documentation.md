# Lab: Exploiting an API endpoint using documentation

To solve the lab, find the exposed API documentation and delete `carlos`. You can log in to your own account using the following credentials: `wiener:peter`.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de compras online:
![image](https://github.com/user-attachments/assets/b7f3817a-c087-423f-ac7b-acaa701c3d77)


Sabemos que tenemos que identificar alg√∫n endpoint API. Procedemos a autenticarnos con nuestras credenciales `wiener:peter` a trav√©s del portal de autenticaci√≥n, al cual accedemos mediante el bot√≥n `My account`:
![image](https://github.com/user-attachments/assets/ef828774-cc90-4583-842d-eb0559742355)

Nos autenticamos:
![image](https://github.com/user-attachments/assets/7e26781f-5b53-4654-8d5b-d03abfd57b19)

Obtenemos una respuesta 302 redirect hacia `my-account`:
![image](https://github.com/user-attachments/assets/350b99ab-9abf-492d-9c83-da93441761fa)

Endpoint `my-account`:
![image](https://github.com/user-attachments/assets/02eb3bbf-a6f9-40d7-8c13-a886b5c233c9)

Si filtramos por `email` vemos que en el c√≥digo fuente est√° el enlace hacia `/resources/js/api/changeEmail.js`:
![image](https://github.com/user-attachments/assets/8cbcd015-1ef2-4b60-8d81-2dc5ba318555)

El cual tramita autom√°ticamente:
![image](https://github.com/user-attachments/assets/1582ce6e-a603-4c93-bc6f-83f0c6140626)

Ahora que identificamos un endpoint API, enviamos la solicitud al `Repeater` para inspeccionarla:
![image](https://github.com/user-attachments/assets/8f4dcf8e-96ff-4bde-a26c-0151a54950b0)

Vemos que nos devuelve un c√≥digo javascript. 


## üß† An√°lisis de c√≥digo JavaScript expuesto: `/resources/js/api/changeEmail.js`

Durante el proceso de reconocimiento de APIs, es com√∫n encontrar archivos JavaScript que revelan la existencia de endpoints sensibles. En este caso, se accedi√≥ al script `/resources/js/api/changeEmail.js` que contiene funcionalidad para cambiar el correo electr√≥nico de un usuario.

### üîç C√≥digo analizado:

```js
const clearErrors = () => {
    [...document.getElementsByClassName('error-message')]
        .forEach(e => e.parentNode.removeChild(e));
};

const displayErrorMessage = (form) => (message) => {
    clearErrors();

    const errorDiv = document.createElement('div');
    errorDiv.setAttribute('class', 'error-message');

    const newWarning = document.createElement('p');
    newWarning.setAttribute('class', 'is-warning');
    newWarning.textContent = message;

    errorDiv.appendChild(newWarning);
    form.parentNode.insertBefore(errorDiv, form);
};

const handleResponse = (showError) => (response) => {
    if (response.error) {
        showError(`${response.type}: ${response.error} (${response.code})`);
    } else {
        window.location.reload();
    }
};

const changeEmail = (form, e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const username = formData.get('username');
    const email = formData.get('email');

    fetch(
        `${form.action}/${encodeURIComponent(username)}`,
        {
            method: 'PATCH',
            body: JSON.stringify({ 'email': email })
        }
    )
        .then(res => res.json())
        .then(handleResponse(displayErrorMessage(form)));
};
```

### ‚úÖ ¬øQu√© hace este c√≥digo?

* Permite cambiar el correo electr√≥nico de un usuario enviando una solicitud PATCH a un endpoint cuya URL incluye el nombre de usuario.
* Usa un `FormData` para extraer los datos del formulario (`username`, `email`).
* Construye din√°micamente una solicitud HTTP con `fetch`, utilizando el m√©todo PATCH y enviando un cuerpo JSON como:

```json
{
  "email": "nuevo_correo@example.com"
}
```


### üîé Endpoint deducido

Este comportamiento revela un endpoint API del estilo:

```http
PATCH /api/changeEmail/<username>
Content-Type: application/json
{
  "email": "nuevo@email.com"
}
```



Si inspeccionamos el formulario podemos encontrar el endpoint API:
![image](https://github.com/user-attachments/assets/efb227c2-c799-4688-9ef6-7085a3b6bc07)

El atributo `action="/api/user"` nos indica que las peticiones se hacen a:
```bash
/api/user/<username>
```

Utilizamos la funci√≥n `Update email`:
![image](https://github.com/user-attachments/assets/786d6b45-ac29-490d-89c3-44d2c4a4d73f)

Enviamos esta solicitud al `Repeater` y procedemos a testearla:
![image](https://github.com/user-attachments/assets/12b11daa-8cc0-4ad3-bb4a-45570bf67a1b)

Para probar efectivamente una API, necesit√°s conocer:

- Datos de entrada esperados (par√°metros obligatorios y opcionales).
- M√©todos HTTP aceptados (GET, HEAD, POST, PUT, DELETE, CONNECT, OPTIONS, TRACE, PATCH).
- Formatos soportados (application/json, application/xml).
- Reglas de autenticaci√≥n y rate-limiting.

Procedemos a probar los m√©todos que acepta:
Notamos que acepta GET sin ning√∫n par√°metro:
![image](https://github.com/user-attachments/assets/e3e29575-e728-4854-b4e0-cda2b45afbf3)
Si intentamos hacerlo sin nuestra cookie no nos permite la operaci√≥n:
![image](https://github.com/user-attachments/assets/19424f60-e776-4650-900b-eb50a31e328b)

HEAD no permite:
![image](https://github.com/user-attachments/assets/738db298-ca43-44ca-bba4-d476876e5149)
POST no permite:
![image](https://github.com/user-attachments/assets/00a5551d-5b8d-4197-9889-d2720d8fa659)

DELETE:
![image](https://github.com/user-attachments/assets/ad9e01cf-9dbc-4151-9239-88636b370787)

CONNECT:
![image](https://github.com/user-attachments/assets/7db5fa36-4f3e-4ad1-a383-29447eb7ff09)

OPTIONS:
![image](https://github.com/user-attachments/assets/80f3e1f5-e5f1-46ae-b5c5-4b246f5c529c)

TRACE:
![image](https://github.com/user-attachments/assets/8fc62669-9c3c-4003-a292-50100d2385a0)


Probamos si podemos cambiar el par√°metro del usuario:
![image](https://github.com/user-attachments/assets/fe57fb49-c761-4738-bae6-c45e04ff7da7)

Esto quiere decir que nos desautenticamos debido a que eliminamos nuestro usuario. Procedemos a reiniciar el laboratorio e intentar obtener los datos de carlos:
![image](https://github.com/user-attachments/assets/44adcdb1-0266-4abb-acd8-539d445c4869)


Obtenemos un data leakage.

Procedemos a intentar buscar la documentaci√≥n yendo hacia atr√°s en el endpoint:
![image](https://github.com/user-attachments/assets/4b8c3a4c-9649-40c4-810a-f367ba176611)

Nos dirijimos a `/api/` y nos encontramos con la documentaci√≥n:
![image](https://github.com/user-attachments/assets/7dd40d63-523e-4f65-8e40-93a4b548d69c)

Utilizamos la api para eliminar al usuario `carlos` y resolver el laboratorio:
![image](https://github.com/user-attachments/assets/605c7723-0fac-403c-97ae-79124fe86dde)

![image](https://github.com/user-attachments/assets/dee42672-2960-42c9-93dc-2ecb6bd23924)










