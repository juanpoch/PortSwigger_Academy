# Lab: Exploiting an API endpoint using documentation

To solve the lab, find the exposed API documentation and delete `carlos`. You can log in to your own account using the following credentials: `wiener:peter`.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de compras online:
![image](https://github.com/user-attachments/assets/b7f3817a-c087-423f-ac7b-acaa701c3d77)


Sabemos que tenemos que identificar alg√∫n endpoint API. Procedemos a autenticarnos con nuestras credenciales `wiener:peter` a trav√©s del portal de autenticaci√≥n, al cual accedemos mediante el bot√≥n `My account`:
![image](https://github.com/user-attachments/assets/ef828774-cc90-4583-842d-eb0559742355)

Nos autenticamos:
![image](https://github.com/user-attachments/assets/7e26781f-5b53-4654-8d5b-d03abfd57b19)

Obtenemos una respuesta 302 redirect hacia `my-account`:
![image](https://github.com/user-attachments/assets/350b99ab-9abf-492d-9c83-da93441761fa)

Endpoint `my-account`:
![image](https://github.com/user-attachments/assets/02eb3bbf-a6f9-40d7-8c13-a886b5c233c9)

Si filtramos por `email` vemos que en el c√≥digo fuente est√° el enlace hacia `/resources/js/api/changeEmail.js`:
![image](https://github.com/user-attachments/assets/8cbcd015-1ef2-4b60-8d81-2dc5ba318555)

El cual tramita autom√°ticamente:
![image](https://github.com/user-attachments/assets/1582ce6e-a603-4c93-bc6f-83f0c6140626)

Ahora que identificamos un endpoint API, enviamos la solicitud al `Repeater` para inspeccionarla:
![image](https://github.com/user-attachments/assets/8f4dcf8e-96ff-4bde-a26c-0151a54950b0)

Vemos que nos devuelve un c√≥digo javascript. 


## üß† An√°lisis de c√≥digo JavaScript expuesto: `/resources/js/api/changeEmail.js`

Durante el proceso de reconocimiento de APIs, es com√∫n encontrar archivos JavaScript que revelan la existencia de endpoints sensibles. En este caso, se accedi√≥ al script `/resources/js/api/changeEmail.js` que contiene funcionalidad para cambiar el correo electr√≥nico de un usuario.

### üîç C√≥digo analizado:

```js
const clearErrors = () => {
    [...document.getElementsByClassName('error-message')]
        .forEach(e => e.parentNode.removeChild(e));
};

const displayErrorMessage = (form) => (message) => {
    clearErrors();

    const errorDiv = document.createElement('div');
    errorDiv.setAttribute('class', 'error-message');

    const newWarning = document.createElement('p');
    newWarning.setAttribute('class', 'is-warning');
    newWarning.textContent = message;

    errorDiv.appendChild(newWarning);
    form.parentNode.insertBefore(errorDiv, form);
};

const handleResponse = (showError) => (response) => {
    if (response.error) {
        showError(`${response.type}: ${response.error} (${response.code})`);
    } else {
        window.location.reload();
    }
};

const changeEmail = (form, e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const username = formData.get('username');
    const email = formData.get('email');

    fetch(
        `${form.action}/${encodeURIComponent(username)}`,
        {
            method: 'PATCH',
            body: JSON.stringify({ 'email': email })
        }
    )
        .then(res => res.json())
        .then(handleResponse(displayErrorMessage(form)));
};
```

### ‚úÖ ¬øQu√© hace este c√≥digo?

* Permite cambiar el correo electr√≥nico de un usuario enviando una solicitud PATCH a un endpoint cuya URL incluye el nombre de usuario.
* Usa un `FormData` para extraer los datos del formulario (`username`, `email`).
* Construye din√°micamente una solicitud HTTP con `fetch`, utilizando el m√©todo PATCH y enviando un cuerpo JSON como:

```json
{
  "email": "nuevo_correo@example.com"
}
```

### üõ°Ô∏è Riesgos potenciales:

| Categor√≠a                               | Riesgo     | Descripci√≥n                                                                                                                                    |
| --------------------------------------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| IDOR (Insecure Direct Object Reference) | ‚ö†Ô∏è Cr√≠tico | Si el backend no verifica que el usuario autenticado coincide con el usuario en la URL, un atacante podr√≠a cambiar el email de otros usuarios. |
| Falta de autenticaci√≥n                  | ‚ö†Ô∏è Cr√≠tico | Si el endpoint no exige un token/session v√°lido, un atacante no autenticado podr√≠a abusar del mismo.                                           |
| Validaci√≥n insuficiente                 | ‚ö†Ô∏è Medio   | Si no hay validaci√≥n de formato para el nuevo correo, se podr√≠an enviar datos maliciosos.                                                      |
| Verbose error handling                  | ‚ö†Ô∏è Leve    | La respuesta contiene mensajes detallados (`type`, `code`) que podr√≠an revelar informaci√≥n sensible del backend.                               |

### üîé Endpoint deducido

Este comportamiento revela un endpoint API del estilo:

```http
PATCH /api/changeEmail/<username>
Content-Type: application/json
{
  "email": "nuevo@email.com"
}
```

### üß† Conclusi√≥n

Este es un ejemplo claro de c√≥mo un an√°lisis minucioso de archivos JavaScript en el frontend puede revelar:

* Funcionalidades no documentadas
* Endpoints vulnerables
* Estructura y m√©todo de interacci√≥n con una API interna

> ‚öôÔ∏è Este tipo de descubrimiento es fundamental en pruebas de seguridad de APIs, y debe realizarse sistem√°ticamente en toda aplicaci√≥n web din√°mica.

---










