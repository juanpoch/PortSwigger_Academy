# Lab: Manipulating WebSocket messages to exploit vulnerabilities

This online shop has a live chat feature implemented using WebSockets.

Chat messages that you submit are viewed by a support agent in real time.

To solve the lab, use a WebSocket message to trigger an `alert()` popup in the support agent's browser.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de compras online:
![image](https://github.com/user-attachments/assets/d722cc9a-17ae-417e-a74c-7b22467a09ad)


Nos dirigimos a `Live chat`:
![image](https://github.com/user-attachments/assets/886f7e11-0c84-407a-af26-8d339dd9b8b5)


Enviamos un mensaje e inspeccionamos la pesta√±a de WebSockets history, recordar que hay que refrescar la p√°gina hasta que aparezca el mensaje `ready`:
![image](https://github.com/user-attachments/assets/1579473c-f080-43de-a87b-73e56f5b92fe)
![image](https://github.com/user-attachments/assets/58b4304b-bea9-4620-ad63-475831d89bf6)



Esto indica que el contenido de los mensajes est√° siendo almacenado y luego retransmitido a otros usuarios (como el agente de soporte), lo cual es clave para explotar un XSS.


![image](https://github.com/user-attachments/assets/45d2731a-4e5b-4127-b284-bd6f510f4fb7)

![image](https://github.com/user-attachments/assets/08bcb8bd-594e-46e1-b7e7-d591b77a252c)

Como tenemos que ejecutar un `alert()` procedemos a enviar el siguiente mensaje. Necesitamos escapar las comillas dobles `"` dentro del atributo onerror porque estamos enviando una cadena dentro de un valor `JSON`. Si no las escapamos, se romper√≠a la estructura del mensaje JSON y no ser√≠a v√°lido. El uso de `\"` garantiza que las comillas dobles se transmitan correctamente como parte del string HTML:
```javascript
<img src=0 onerror=\"alert(1)\">
```
![image](https://github.com/user-attachments/assets/bf8fd216-9bd1-4c20-8a74-59fe20c06198)

Vemos que se insert√≥ como cadena y no como etiqueta (las etiquetas tienen otro color):
![image](https://github.com/user-attachments/assets/853cdd45-35b9-4189-9667-8f7922f737b5)

Nosotros recibimos el siguiente json, el payload se codific√≥ autom√°ticamente como entidades HTML::
```json
{
  "message": "&lt;img src=0 onerror=&#x5c;&quot;alert(1)&#x5c;&quot;&gt;"
}
```

Esto evit√≥ que se interpretara como una etiqueta HTML, ya que el navegador lo mostr√≥ como texto.

Para solucionarlo, usamos Burp Repeater, donde tenemos control total sobre el contenido del mensaje WebSocket sin re-encoding autom√°tico:
![image](https://github.com/user-attachments/assets/f7cc6673-11d3-4f4c-9b1e-1a6146d8f7d7)

Modificamos el valor enviado e ingresamos el payload tal cual lo quer√≠amos enviar (si se tarda cierto tiempo hay que reconectar):
![image](https://github.com/user-attachments/assets/f9ca1f46-0a31-4a80-a0b5-5f246856c65f)

Si observamos el laboratorio, vemos que nos insert√≥ una imagen, si la inspeccionamos vemos que se insert√≥ correctamente la etiqueta:
![image](https://github.com/user-attachments/assets/236f6a62-dbed-4fac-b5af-9f8e445a2aac)


Vemos que resolvimos el laboratorio:
![image](https://github.com/user-attachments/assets/a1ca05dc-b4b5-4e2a-8a56-3febba29946b)

Otra forma de resolverlo es interceptando la request:
![image](https://github.com/user-attachments/assets/57356b68-975f-408c-a92d-3151d6eb9b9b)

![image](https://github.com/user-attachments/assets/1a06c9b5-11dc-4e7a-a8b9-de82b266fc8a)

---

---

## ‚úÖ Conclusiones

- La funcionalidad de chat implementada con WebSockets refleja directamente el contenido enviado por el usuario a otros clientes (en este caso, el agente de soporte), sin aplicar ninguna sanitizaci√≥n.
- Esto permiti√≥ realizar un ataque de **XSS reflejado** al insertar una etiqueta `<img>` con un manejador `onerror`, ejecutando c√≥digo JavaScript en el navegador del receptor.
- El intento inicial desde el navegador fall√≥ porque el cliente codific√≥ autom√°ticamente los caracteres peligrosos (`<`, `>`, `"`) como entidades HTML, neutralizando el payload.
- Usar **Burp Repeater** fue clave para enviar el payload crudo sin codificaci√≥n autom√°tica, permitiendo la explotaci√≥n efectiva.

---

## üîê Recomendaciones

- **Validar y sanitizar el contenido** de todos los mensajes entrantes del lado del servidor, especialmente aquellos que ser√°n renderizados en HTML.
- Implementar un **Content Security Policy (CSP)** restrictivo para mitigar el impacto de XSS si ocurre.
- Evitar reflejar directamente datos del usuario en la interfaz sin escaparlos adecuadamente.
- Revisar las funciones de chat o comunicaci√≥n en tiempo real para asegurarse de que **no act√∫an como canales de reflejo directo** de entrada no confiable.

---

## üìö Lecciones aprendidas

- Los WebSockets, aunque modernos y eficientes, est√°n sujetos a las mismas vulnerabilidades cl√°sicas que el tr√°fico HTTP, incluyendo XSS.
- El entorno cliente puede modificar el contenido antes de enviarlo (por ejemplo, escapando comillas), lo que puede ocultar vulnerabilidades si no se inspecciona el tr√°fico real.
- Herramientas como Burp Suite permiten **control granular del tr√°fico WebSocket** y son esenciales para pruebas avanzadas.
- Siempre es √∫til inspeccionar c√≥mo se renderiza el contenido final en el navegador destino (en este caso, el agente) para verificar si el ataque funcion√≥ correctamente.

---






