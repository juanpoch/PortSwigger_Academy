# Lab: CSRF vulnerability with no defenses

This lab's email change functionality is vulnerable to CSRF.

To solve the lab, craft some HTML that uses a CSRF attack to change the viewer's email address and upload it to your exploit server.

You can log in to your own account using the following credentials: `wiener:peter`

`Hint`: You cannot register an email address that is already taken by another user. If you change your own email address while testing your exploit, make sure you use a different email address for the final exploit you deliver to the victim.

![Practitioner](https://img.shields.io/badge/level-Apprentice-green) 

---

Iniciamos el laboratorio y nos encontramos con un foro p√∫blico:
![image](https://github.com/user-attachments/assets/e24589e2-f7ab-40e7-9907-a8652fafccb6)

Nosotros sabemos que este laboratorio tiene una funcionalidad de cambio de email vulnerable a CSRF por lo tanto procedemos a autenticarnos con nuestro usuario `wiener:peter`:
![image](https://github.com/user-attachments/assets/c2a76d52-4b73-437a-8174-8ce90058d0e1)

Observamos el dashboard principal del usuario:
![image](https://github.com/user-attachments/assets/b928d13a-12ea-43b7-8bcb-6fbe4d8759e9)

Tenemos a la vista la funcionalidad de cambio de email, que se puede acceder mediante el bot√≥n `Update email`.

Procedemos a cambiar nuestro email para analizar el proceso:
![image](https://github.com/user-attachments/assets/ee3909bb-9fe2-46ea-b720-136de2531196)

Nosotros sabemos que para que exista vulnerabilidad `CSRF` necesitamos cumplir 3 condiciones:
- `Acci√≥n relevante`: Debe existir una acci√≥n que interese al atacante (en este caso cambio de email).
- `Manejo de sesi√≥n basado en cookies`: El sitio usa cookies autom√°ticas para identificar al usuario, sin ning√∫n otro mecanismo adicional de validaci√≥n (ausencia de token CSRF).
- `Par√°metros predecibles`: El atacante puede predecir o controlar los par√°metros necesarios en la solicitud HTTP (en este caso manejamos un √∫nico par√°metro `email`).

La aplicaci√≥n es vulnerable a CSRF, por lo que enviamos la solicitud al `Repeater`, hacemos click derecho en la solicitud, luego `Engagement tools`, luego `Generate CSRF PoC`.
Nos aparece una nueva ventana, hacemos click en `Regenerate`:
![image](https://github.com/user-attachments/assets/57f0d957-62ab-4678-ae2c-6ccce0280f40)


`Nota`: Verificar en `Options` que est√© tildado `Include auto-submit script`.

Obtuvimos el siguiente script:
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a69009d03f08c4b800c032e004c005b.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

### ‚úçÔ∏è An√°lisis paso a paso

#### 1. `<form action=... method="POST">`

Se crea un formulario HTML que apunta a la ruta vulnerable donde se realiza el cambio de email. Utiliza el m√©todo **POST**, necesario para muchas operaciones cr√≠ticas.

#### 2. `<input type="hidden" name="email" value="test&#64;test&#46;com" />`

Campo oculto que contiene el valor malicioso que se desea enviar. Se usa codificaci√≥n HTML para los caracteres especiales:

* `&#64;` ‚Üí `@`
* `&#46;` ‚Üí `.`

Este campo simula que el usuario quiere cambiar su correo a `test@test.com`.

#### 3. `<input type="submit" value="Submit request" />`

Bot√≥n de env√≠o tradicional. Aunque **no se usar√° manualmente**, es necesario para que el formulario sea v√°lido.

#### 4. `<script> history.pushState('', '', '/'); document.forms[0].submit(); </script>`

Script que **automatiza** el ataque:

* `history.pushState('', '', '/')`: modifica la URL en la barra de direcciones para **ocultar el path del exploit** y hacerlo parecer m√°s leg√≠timo.
* `document.forms[0].submit();`: env√≠a autom√°ticamente el formulario cuando se carga la p√°gina.

---

### üí° Resultado esperado

Si un usuario autenticado visita esta p√°gina:

* El navegador enviar√° el formulario POST a la aplicaci√≥n vulnerable.
* El servidor usar√° las cookies del usuario (ya que son autom√°ticamente incluidas).
* El email del usuario ser√° modificado sin que se d√© cuenta.

---

Debido a que necesitamos que un usuario autenticado visite esta p√°gina maliciosa, tenemos que levantar nuestro propio servidor con la p√°gina. En este caso, la funcionalidad `Go to exploit server` del laboratorio simula este proceso.

Hacemos click en `Go to exploit server` y desarrollamos nuestra p√°gina maliciosa:
![image](https://github.com/user-attachments/assets/50940454-6d22-456b-aebe-68861dbfee4a)

Para analizar si nuestro exploit funciona, primero hacemos click en `Store` (es fundamental para que el exploit funcione), y luego hacemos click en `View exploit`, si vemos que nuestro mail fue cambiado significa que el exploit funciona.

Hacemos click en `Deliver exploit to victim` para simular que el usuario v√≠ctima accede a nuestra p√°gina y resolvemos el laboratorio:
![image](https://github.com/user-attachments/assets/90e4901b-a6ef-4e25-8fe0-4e2ec326db0c)

---

---

## ‚úÖ Conclusiones

- Este laboratorio demuestra una vulnerabilidad **CSRF (Cross-Site Request Forgery)** en una funcionalidad sensible: el cambio de direcci√≥n de correo electr√≥nico.
- La aplicaci√≥n **no implementa ning√∫n mecanismo de defensa** contra CSRF, lo que permite que un atacante construya una p√°gina maliciosa que explota la sesi√≥n activa del usuario.
- Al visitar la p√°gina del atacante, el navegador del usuario **env√≠a autom√°ticamente la cookie de sesi√≥n**, permitiendo ejecutar acciones sin su consentimiento.
- La falta de validaci√≥n (como tokens CSRF, cabeceras referer o pol√≠ticas SameSite) hace que la aplicaci√≥n sea trivialmente explotable.

---

## üõ°Ô∏è Recomendaciones

- Implementar **tokens CSRF** en formularios sensibles y verificar su validez en el servidor.
- Utilizar cookies con el atributo `SameSite` configurado como `Strict` o `Lax` para restringir el env√≠o de cookies en peticiones cross-site.
- Validar el **Referer** y/o el **Origin** de las solicitudes entrantes como defensa secundaria.
- Evitar cambios cr√≠ticos mediante m√©todos GET, y **preferir POST con validaci√≥n adicional**.
- Asegurar que formularios sensibles incluyan alg√∫n tipo de comprobaci√≥n del usuario, como reautenticaci√≥n o confirmaci√≥n visual.

---

## üéì Lecciones aprendidas

- CSRF permite a un atacante forzar al navegador de una v√≠ctima a realizar acciones no deseadas en una aplicaci√≥n en la que est√° autenticada.
- Las aplicaciones que conf√≠an √∫nicamente en cookies para mantener el estado de sesi√≥n son vulnerables si no agregan defensas adicionales.
- Herramientas como **Burp Suite** pueden generar autom√°ticamente exploits CSRF v√°lidos, simplificando la explotaci√≥n.
- Los ataques CSRF son silenciosos para el usuario y pueden tener **graves consecuencias**, especialmente en aplicaciones con funciones administrativas o financieras.
- Siempre que haya una funcionalidad sensible accesible v√≠a POST, se debe validar que la solicitud **proviene realmente del usuario leg√≠timo**.

---
